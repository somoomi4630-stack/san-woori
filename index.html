<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‚°ìš°ë¦¬ ë“±ì‚° ë™í˜¸íšŒ ê´€ë¦¬</title>
    <style>
        body { font-family: 'Apple SD Gothic Neo', 'Malgun Gothic', sans-serif; background-color: #f0f2f5; padding: 20px; margin: 0; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .tabs { display: flex; margin-bottom: 20px; border-radius: 8px; overflow: hidden; border: 1px solid #ddd; }
        .tab-btn { flex: 1; padding: 15px; border: none; cursor: pointer; background: #f8f9fa; font-weight: bold; font-size: 16px; transition: 0.3s; }
        .tab-btn.active { background: #1877f2; color: white; }
        .content { display: none; padding: 10px; }
        .content.active { display: block; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border-bottom: 1px solid #ddd; padding: 12px; text-align: center; }
        th { background: #f8f9fa; color: #333; }
        .level-badge { background: #e7f3ff; color: #1877f2; padding: 4px 10px; border-radius: 12px; font-size: 0.85em; font-weight: bold; white-space: nowrap; }
        .admin-lock { text-align: center; padding: 50px; border: 1px dashed #ccc; border-radius: 10px; }
        input, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 14px; }
        .btn-save { background: #28a745; color: white; border: none; padding: 14px; width: 100%; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; margin-top: 5px; }
        .btn-save:disabled { background: #ccc; cursor: not-allowed; }
        .loading-text { text-align: center; color: #666; padding: 20px; font-style: italic; }
        hr { border: 0; border-top: 1px solid #eee; margin: 20px 0; }
    </style>
</head>
<body>

<div class="container">
    <div class="tabs">
        <button id="tab-dash" class="tab-btn active" onclick="showTab('dashboard')">ğŸ“Š ì‹¤ì‹œê°„ í˜„í™©</button>
        <button id="tab-admin" class="tab-btn" onclick="showTab('management')">ğŸ” ê´€ë¦¬ì ì„¤ì •</button>
    </div>

    <div id="dashboard" class="content active">
        <h2 style="margin-top:0;">ğŸ”ï¸ íšŒì› ë“±ì‚° ë“±ê¸‰í‘œ</h2>
        <div style="text-align: right; margin-bottom: 10px;">
            <label style="font-size:14px; font-weight:bold;">ë¶„ê¸° ì„ íƒ: </label>
            <select id="qSelect" onchange="renderUI()" style="width:160px; display:inline-block;"></select>
        </div>
        <div id="loader" class="loading-text">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
        <table id="mainTable" style="display:none;">
            <thead>
                <tr>
                    <th>íšŒì›ëª…</th>
                    <th>ë ˆë²¨(ì´í•©)</th>
                    <th>ë¶„ê¸° íšŸìˆ˜</th>
                </tr>
            </thead>
            <tbody id="memberList"></tbody>
        </table>
    </div>

    <div id="management" class="content">
        <div id="lockScreen" class="admin-lock">
            <h3>ê´€ë¦¬ì ì•”í˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”</h3>
            <p style="color:#888; font-size:13px;">íšŒì› ë“±ë¡ ë° ì‚­ì œë¥¼ ìœ„í•´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
            <input type="password" id="adminPw" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" onkeypress="if(event.keyCode==13) unlockAdmin()">
            <button class="btn-save" onclick="unlockAdmin()" style="margin-top:10px; background:#1877f2;">ì ‘ì†í•˜ê¸°</button>
        </div>
        
        <div id="adminContent" style="display:none;">
            <div style="background:#f8f9fa; padding:15px; border-radius:8px; margin-bottom:20px; border:1px solid #eee;">
                <h3 style="margin-top:0; color:#2c3e50;">ğŸ†• ì‹ ê·œ íšŒì› ë“±ë¡</h3>
                <input type="text" id="mName" placeholder="íšŒì› ì´ë¦„ ì…ë ¥">
                <input type="date" id="mDate">
                <button id="btnAddMember" class="btn-save" onclick="handleApi('addMember')">íšŒì› ì¶”ê°€ ì™„ë£Œ</button>
            </div>

            <div style="background:#f8f9fa; padding:15px; border-radius:8px; margin-bottom:20px; border:1px solid #eee;">
                <h3 style="margin-top:0; color:#2c3e50;">ğŸ“… ë“±ì‚° ê¸°ë¡ ì¶”ê°€</h3>
                <select id="mSelect"><option value="">íšŒì›ì„ ì„ íƒí•˜ì„¸ìš”</option></select>
                <input type="date" id="hDate">
                <button id="btnAddHike" class="btn-save" style="background:#007bff;" onclick="handleApi('addHike')">ë“±ì‚° ê¸°ë¡ ì €ì¥</button>
            </div>

            <div style="background:#fff5f5; padding:15px; border-radius:8px; border:1px solid #ffcccc;">
                <h3 style="margin-top:0; color:#c0392b;">ğŸ—‘ï¸ íšŒì› ì‚­ì œ</h3>
                <p style="font-size:12px; color:#e74c3c; margin-top:-5px;">* í•´ë‹¹ íšŒì›ì˜ ëª¨ë“  ê¸°ë¡ì´ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.</p>
                <select id="dSelect"><option value="">ì‚­ì œí•  íšŒì›ì„ ì„ íƒí•˜ì„¸ìš”</option></select>
                <button id="btnDelMember" class="btn-save" style="background:#dc3545;" onclick="handleApi('deleteMember')">ì„ íƒ íšŒì› ì˜êµ¬ ì‚­ì œ</button>
            </div>
        </div>
    </div>
</div>

<script>
    // âš ï¸ [ì¤‘ìš”] ë³¸ì¸ì˜ êµ¬ê¸€ ì›¹ ì•± URLì„ ì•„ë˜ì— ë„£ìœ¼ì„¸ìš”!
    const API_URL = "https://script.google.com/macros/s/AKfycbySsFZxHczWCZUQvm17BL99EIK6gTHDW0kcz8ej50AOd9H7iG8ZKRAw9dPVTaV0TuAz/exec"; 
    const ADMIN_PASSWORD = "1229"; // ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸

    let db = { members: [], hikes: [] };

    // í˜ì´ì§€ ì‹œì‘ ì‹œ ì‹¤í–‰
    window.onload = async () => {
        // ì˜¤ëŠ˜ ë‚ ì§œë¡œ ê¸°ë³¸ ì„¸íŒ…
        const today = new Date().toISOString().substring(0, 10);
        document.getElementById('mDate').value = today;
        document.getElementById('hDate').value = today;
        await loadData();
    };

    // ì„œë²„ì—ì„œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadData() {
        try {
            const response = await fetch(`${API_URL}?action=read`);
            db = await response.json();
            
            initQuarterSelect();      // ë¶„ê¸° ëª©ë¡ ìƒì„±
            updateMemberDropdowns();  // ê´€ë¦¬ì ë©”ë‰´ ë“œë¡­ë‹¤ìš´ ê°±ì‹ 
            renderUI();               // í…Œì´ë¸” ê·¸ë¦¬ê¸°
            
            document.getElementById('loader').style.display = 'none';
            document.getElementById('mainTable').style.display = 'table';
        } catch (e) {
            console.error(e);
            alert("ì„œë²„ ì—°ê²° ì‹¤íŒ¨! API URLì„ í™•ì¸í•˜ì„¸ìš”.");
        }
    }

    // ì„œë²„ì— ë°ì´í„° ë³´ë‚´ê¸° (ì¶”ê°€/ì‚­ì œ)
    async function handleApi(action) {
        let payload = { action: action };
        const btn = event.target;
        const originalText = btn.innerText;

        if (action === 'addMember') {
            const name = document.getElementById('mName').value;
            const date = document.getElementById('mDate').value;
            if(!name || !date) return alert("ì´ë¦„ê³¼ ê°€ì…ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            payload = { ...payload, id: Date.now(), name: name, joinDate: date };
        } 
        else if (action === 'addHike') {
            const mId = document.getElementById('mSelect').value;
            const date = document.getElementById('hDate').value;
            if(!mId || !date) return alert("íšŒì›ê³¼ ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
            payload = { ...payload, memberId: mId, date: date };
        }
        else if (action === 'deleteMember') {
            const mId = document.getElementById('dSelect').value;
            if(!mId || !confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ê´€ë ¨ ê¸°ë¡ì´ ëª¨ë‘ ì‚¬ë¼ì§‘ë‹ˆë‹¤.")) return;
            payload = { ...payload, id: mId };
        }

        // ë²„íŠ¼ ìƒíƒœ ë³€ê²½
        btn.disabled = true;
        btn.innerText = "ì²˜ë¦¬ ì¤‘...";

        try {
            await fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify(payload)
            });
            
            alert("ì„±ê³µì ìœ¼ë¡œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.");

            // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
            if (action === 'addMember') {
                document.getElementById('mName').value = "";
            }

            // [í•µì‹¬] ë¡œê·¸ì¸ ìœ ì§€í•˜ë©° ë°ì´í„°ë§Œ ê°±ì‹ 
            await loadData(); 
            
        } catch (e) {
            alert("ì—°ê²° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        } finally {
            btn.disabled = false;
            btn.innerText = originalText;
        }
    }

    // ë ˆë²¨ ê³„ì‚° ë¡œì§
    function getLevel(n) {
        if (n >= 50) return 'ğŸŒŒ í–‰ì„±ê³„';
        if (n >= 45) return 'ğŸŒ  ë³„ë˜¥ë³„';
        if (n >= 40) return 'ğŸ’« íƒ€ì›ë³„';
        if (n >= 35) return 'ğŸŒŸ ë¹›ë³„';
        if (n >= 30) return 'â­ï¸ ë³„';
        if (n >= 25) return 'ğŸŒ• ë‹¬';
        if (n >= 20) return 'â˜€ï¸ í•´';
        if (n >= 15) return 'ğŸŒˆ ë¬´ì§€ê°œ';
        if (n >= 10) return 'â›°ï¸ ì‚°';
        if (n >= 5)  return 'ğŸŒ³ ë‚˜ë¬´';
        if (n >= 3)  return 'ğŸŒ¿ í’€ì';
        return 'ğŸŒ± ìƒˆì‹¹';
    }

    // ë¶„ê¸° í…ìŠ¤íŠ¸ ê³„ì‚°
    function getQuarter(dateStr) {
        const d = new Date(dateStr);
        return `${d.getFullYear()}ë…„ ${Math.ceil((d.getMonth()+1)/3)}ë¶„ê¸°`;
    }

    // ë¶„ê¸° ì„ íƒì°½ ì±„ìš°ê¸°
    function initQuarterSelect() {
        const select = document.getElementById('qSelect');
        const currentVal = select.value; // í˜„ì¬ ì„ íƒê°’ ìœ ì§€ìš©
        
        const qs = new Set();
        qs.add(getQuarter(new Date()));
        db.hikes.forEach(h => qs.add(getQuarter(h.date)));
        
        select.innerHTML = "";
        Array.from(qs).sort().reverse().forEach(q => {
            select.innerHTML += `<option value="${q}">${q}</option>`;
        });
        
        if(currentVal) select.value = currentVal;
    }

    // ê´€ë¦¬ì ë©”ë‰´ì˜ íšŒì› ëª©ë¡ ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
    function updateMemberDropdowns() {
        const mSelect = document.getElementById('mSelect');
        const dSelect = document.getElementById('dSelect');
        
        const defaultM = '<option value="">íšŒì› ì„ íƒ</option>';
        const defaultD = '<option value="">ì‚­ì œí•  íšŒì› ì„ íƒ</option>';
        
        mSelect.innerHTML = defaultM;
        dSelect.innerHTML = defaultD;

        db.members.forEach(m => {
            const opt = `<option value="${m.id}">${m.name}</option>`;
            mSelect.innerHTML += opt;
            dSelect.innerHTML += opt;
        });
    }

    // í˜„í™©íŒ í…Œì´ë¸” ê·¸ë¦¬ê¸°
    function renderUI() {
        const targetQ = document.getElementById('qSelect').value;
        const tbody = document.getElementById('memberList');
        tbody.innerHTML = "";

        // íšŒì›ë³„ë¡œ ëŒë©´ì„œ íšŸìˆ˜ ê³„ì‚°
        db.members.forEach(m => {
            const total = db.hikes.filter(h => String(h.memberId) === String(m.id)).length;
            const qCount = db.hikes.filter(h => String(h.memberId) === String(m.id) && getQuarter(h.date) === targetQ).length;
            
            tbody.innerHTML += `
                <tr>
                    <td style="font-weight:bold;">${m.name}</td>
                    <td><span class="level-badge">${getLevel(total)}</span> <br><small style="color:#888">(${total}íšŒ)</small></td>
                    <td style="color:#e74c3c; font-weight:bold; font-size:1.1em;">${qCount}íšŒ</td>
                </tr>`;
        });
    }

    // ê´€ë¦¬ì ë¡œê·¸ì¸
    function unlockAdmin() {
        const pw = document.getElementById('adminPw').value;
        if(pw === ADMIN_PASSWORD) {
            document.getElementById('lockScreen').style.display = 'none';
            document.getElementById('adminContent').style.display = 'block';
        } else {
            alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            document.getElementById('adminPw').value = "";
        }
    }

    // íƒ­ ì „í™˜
    function showTab(id) {
        document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(id === 'dashboard') {
            document.getElementById('tab-dash').classList.add('active');
            renderUI();
        } else {
            document.getElementById('tab-admin').classList.add('active');
        }
    }
</script>
</body>
</html>
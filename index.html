<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‚°ìš°ë¦¬ ë“±ì‚° ë™í˜¸íšŒ ê´€ë¦¬</title>
    <style>
        body { font-family: 'Apple SD Gothic Neo', 'Malgun Gothic', sans-serif; background-color: #f0f2f5; padding: 20px; margin: 0; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .tabs { display: flex; margin-bottom: 20px; border-radius: 8px; overflow: hidden; border: 1px solid #ddd; }
        .tab-btn { flex: 1; padding: 15px; border: none; cursor: pointer; background: #f8f9fa; font-weight: bold; font-size: 16px; transition: 0.3s; }
        .tab-btn.active { background: #1877f2; color: white; }
        .content { display: none; padding: 10px; }
        .content.active { display: block; }
        
        /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 14px; }
        th, td { border-bottom: 1px solid #ddd; padding: 12px; text-align: center; }
        th { background: #f8f9fa; color: #333; font-weight: bold; }
        
        /* ë±ƒì§€ ë° ë ˆë²¨ ìŠ¤íƒ€ì¼ */
        .level-badge { background: #e7f3ff; color: #1877f2; padding: 4px 10px; border-radius: 12px; font-size: 0.85em; font-weight: bold; white-space: nowrap; }
        .level-text { font-size: 0.85em; color: #666; margin-top: 4px; display: block; }
        
        .admin-lock { text-align: center; padding: 50px; border: 1px dashed #ccc; border-radius: 10px; }
        input, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 14px; }
        .btn-save { background: #28a745; color: white; border: none; padding: 14px; width: 100%; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; margin-top: 5px; }
        .d-day-urgent { color: #e74c3c; font-weight: bold; }
        .loading-text { text-align: center; color: #666; padding: 20px; }

        /* [NEW] ë“±ì‚° ê¸°ë¡ ìˆ˜ì •ìš© ê·¸ë¦¬ë“œ ìŠ¤íƒ€ì¼ */
        .hike-grid-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr); /* 4ì—´ */
            gap: 8px;
            max-height: 250px; /* ëŒ€ëµ 5í–‰ ë†’ì´ */
            overflow-y: auto; /* ìŠ¤í¬ë¡¤ë°” ìƒì„± */
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 8px;
            background: #fff;
            margin-top: 10px;
        }
        .hike-item {
            background: #f1f3f5;
            padding: 10px 5px;
            text-align: center;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: 0.2s;
            border: 1px solid transparent;
        }
        .hike-item:hover {
            background: #e2e6ea;
            border-color: #adb5bd;
        }
        .hike-item.selected {
            background: #cce5ff;
            color: #004085;
            border-color: #b8daff;
            font-weight: bold;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="tabs">
        <button id="tab-dash" class="tab-btn active" onclick="showTab('dashboard')">ğŸ“Š ì‹¤ì‹œê°„ í˜„í™©</button>
        <button id="tab-admin" class="tab-btn" onclick="showTab('management')">ğŸ” ê´€ë¦¬ì ì„¤ì •</button>
    </div>

    <div id="dashboard" class="content active">
        <h2 style="margin-top:0;">ğŸ”ï¸ íšŒì› ë“±ì‚° ë“±ê¸‰í‘œ</h2>
        <div style="text-align: right; margin-bottom: 10px;">
            <label style="font-size:14px; font-weight:bold;">ë¶„ê¸° ì„ íƒ: </label>
            <select id="qSelect" onchange="renderUI()" style="width:160px; display:inline-block;"></select>
        </div>
        <div id="loader" class="loading-text">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
        <table id="mainTable" style="display:none;">
            <thead>
                <tr>
                    <th style="width:25%">íšŒì›ëª…</th>
                    <th style="width:25%">ë ˆë²¨(Lv)</th> <th style="width:25%">ë¶„ê¸° íšŸìˆ˜</th>
                    <th style="width:25%">ë‚¨ì€ ë‚ ì§œ</th>
                </tr>
            </thead>
            <tbody id="memberList"></tbody>
        </table>
    </div>

    <div id="management" class="content">
        <div id="lockScreen" class="admin-lock">
            <h3>ê´€ë¦¬ì ì•”í˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”</h3>
            <input type="password" id="adminPw" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" onkeypress="if(event.keyCode==13) unlockAdmin()">
            <button class="btn-save" onclick="unlockAdmin()" style="margin-top:10px; background:#1877f2;">ì ‘ì†í•˜ê¸°</button>
        </div>
        
        <div id="adminContent" style="display:none;">
            <div style="background:#f8f9fa; padding:15px; border-radius:8px; margin-bottom:20px; border:1px solid #eee;">
                <h3 style="margin:0 0 10px 0;">ğŸ†• ì‹ ê·œ íšŒì› ë“±ë¡</h3>
                <input type="text" id="mName" placeholder="íšŒì› ì´ë¦„ ì…ë ¥">
                <input type="date" id="mDate">
                <button class="btn-save" onclick="handleApi('addMember')">íšŒì› ì¶”ê°€ ì™„ë£Œ</button>
            </div>

            <div style="background:#f8f9fa; padding:15px; border-radius:8px; margin-bottom:20px; border:1px solid #eee;">
                <h3 style="margin:0 0 10px 0;">ğŸ“… ë“±ì‚° ê¸°ë¡ ì¶”ê°€</h3>
                <select id="mSelect"><option value="">íšŒì›ì„ ì„ íƒí•˜ì„¸ìš”</option></select>
                <input type="date" id="hDate">
                <button class="btn-save" style="background:#007bff;" onclick="handleApi('addHike')">ê¸°ë¡ ì €ì¥</button>
            </div>

            <div style="background:#fff9db; padding:15px; border-radius:8px; margin-bottom:20px; border:1px solid #ffe066;">
                <h3 style="margin:0 0 5px 0; color:#856404;">âœï¸ ë“±ì‚° ê¸°ë¡ ìˆ˜ì •/ì‚­ì œ</h3>
                <p style="font-size:12px; color:#666; margin-bottom:10px;">íšŒì›ì„ ì„ íƒí•˜ê³  ë‚ ì§œë¥¼ í´ë¦­í•˜ì—¬ ìˆ˜ì •í•˜ê±°ë‚˜ ì‚­ì œí•˜ì„¸ìš”.</p>
                
                <select id="editMemberSelect" onchange="renderHikeGrid(this.value)">
                    <option value="">ê¸°ë¡ì„ í™•ì¸í•  íšŒì› ì„ íƒ</option>
                </select>
                
                <div id="hikeGrid" class="hike-grid-container" style="display:none;"></div>
            </div>

            <div style="background:#fff5f5; padding:15px; border-radius:8px; border:1px solid #ffcccc;">
                <h3 style="margin:0 0 10px 0; color:#c0392b;">ğŸ—‘ï¸ íšŒì› ì‚­ì œ</h3>
                <select id="dSelect"><option value="">ì‚­ì œí•  íšŒì› ì„ íƒ</option></select>
                <button class="btn-save" style="background:#dc3545;" onclick="handleApi('deleteMember')">ì„ íƒ íšŒì› ì˜êµ¬ ì‚­ì œ</button>
            </div>
        </div>
    </div>
</div>

<script>
    // âš ï¸ ë³¸ì¸ì˜ API URLì„ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”
    const API_URL = "https://script.google.com/macros/s/AKfycbySsFZxHczWCZUQvm17BL99EIK6gTHDW0kcz8ej50AOd9H7iG8ZKRAw9dPVTaV0TuAz/exec"; 
    const ADMIN_PASSWORD = "1229"; 

    let db = { members: [], hikes: [] };

    window.onload = async () => {
        const today = new Date().toISOString().substring(0, 10);
        document.getElementById('mDate').value = today;
        document.getElementById('hDate').value = today;
        await loadData();
    };

    async function loadData() {
        try {
            const response = await fetch(`${API_URL}?action=read`);
            const data = await response.json();
            db.members = data.members || [];
            db.hikes = data.hikes || [];
            
            initQuarterSelect();
            updateMemberDropdowns();
            renderUI();
            
            document.getElementById('loader').style.display = 'none';
            document.getElementById('mainTable').style.display = 'table';
            
            // ë§Œì•½ ìˆ˜ì •/ì‚­ì œ ê·¸ë¦¬ë“œê°€ ì—´ë ¤ìˆë‹¤ë©´ ê°±ì‹ 
            const currentEditMember = document.getElementById('editMemberSelect').value;
            if(currentEditMember) renderHikeGrid(currentEditMember);

        } catch (e) {
            console.error(e);
        }
    }

    async function handleApi(action, extraData = {}) {
        let payload = { action: action, ...extraData };
        
        // 1. íšŒì› ì¶”ê°€
        if (action === 'addMember') {
            const name = document.getElementById('mName').value;
            const date = document.getElementById('mDate').value;
            if(!name || !date) return alert("ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
            payload = { ...payload, id: Date.now(), name: name, joinDate: date };
        } 
        // 2. ê¸°ë¡ ì¶”ê°€
        else if (action === 'addHike') {
            const mId = document.getElementById('mSelect').value;
            const date = document.getElementById('hDate').value;
            if(!mId || !date) return alert("ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
            payload = { ...payload, memberId: mId, date: date };
        }
        // 3. íšŒì› ì‚­ì œ
        else if (action === 'deleteMember') {
            const mId = document.getElementById('dSelect').value;
            if(!mId || !confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            payload = { ...payload, id: mId };
        }
        // 4. ê¸°ë¡ ìˆ˜ì •/ì‚­ì œ (extraDataë¡œ ë„˜ì–´ì˜´) -> ë³„ë„ ì²˜ë¦¬ í•„ìš” ì—†ìŒ

        // ë¡œë”© í‘œì‹œ
        const btns = document.querySelectorAll('button');
        btns.forEach(b => b.disabled = true);
        
        try {
            await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
            alert("ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
            
            // ì…ë ¥ì°½ ì´ˆê¸°í™”
            if (action === 'addMember') document.getElementById('mName').value = "";
            
            // ë°ì´í„° ê°±ì‹ 
            await loadData(); 
        } catch (e) { 
            alert("ì˜¤ë¥˜ ë°œìƒ: ìŠ¤í¬ë¦½íŠ¸ ë°°í¬ ë²„ì „ì„ í™•ì¸í•˜ì„¸ìš”."); 
        } finally { 
            btns.forEach(b => b.disabled = false); 
        }
    }

    // --- [NEW] ê·¸ë¦¬ë“œ ë Œë”ë§ í•¨ìˆ˜ ---
   // --- [ìˆ˜ì •ëœ] ê·¸ë¦¬ë“œ ë Œë”ë§ í•¨ìˆ˜ ---
    function renderHikeGrid(memberId) {
        const grid = document.getElementById('hikeGrid');
        if (!memberId) {
            grid.style.display = 'none';
            return;
        }
        
        const myHikes = db.hikes
            .filter(h => String(h.memberId) === String(memberId))
            .map(h => {
                let d = new Date(h.date);
                // ë‚ ì§œ ì¸ì‹ ë³´ì • (ì  í¬í•¨ í˜•ì‹ ë“±)
                if(isNaN(d.getTime())) {
                    let str = String(h.date).replace(/\./g, '-').replace(/\s/g, '');
                    d = new Date(str);
                }
                return d;
            })
            .filter(d => !isNaN(d.getTime()))
            .sort((a, b) => b - a);

        if(myHikes.length === 0) {
            grid.style.display = 'block';
            grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:20px; color:#666;">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
            return;
        }

        grid.style.display = 'grid';
        grid.innerHTML = "";

        myHikes.forEach(dateObj => {
            const yy = String(dateObj.getFullYear()).slice(2);
            const mm = String(dateObj.getMonth() + 1).padStart(2, '0');
            const dd = String(dateObj.getDate()).padStart(2, '0');
            
            const dateStr = `${yy}.${mm}.${dd}`; // í™”ë©´ í‘œì‹œìš© (25.12.30)
            const fullDateStr = `${dateObj.getFullYear()}-${mm}-${dd}`; // ì„œë²„ ì „ì†¡ìš© (2025-12-30)

            const item = document.createElement('div');
            item.className = 'hike-item';
            item.innerText = dateStr;
            item.onclick = () => {
                const choice = prompt(`[${dateStr}] ê¸°ë¡ ì„ íƒ\n\n1. ìˆ˜ì •: ìƒˆë¡œìš´ ë‚ ì§œ ì…ë ¥ (ì˜ˆ: 2025-01-01)\n2. ì‚­ì œ: "ì‚­ì œ" ì…ë ¥`, fullDateStr);
                
                if (choice === null) return;
                
                if (choice.trim() === "ì‚­ì œ") {
                    if(confirm("ì •ë§ ì´ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                        handleApi('deleteHike', { memberId: memberId, date: fullDateStr });
                    }
                } else {
                    // ë‚ ì§œ í˜•ì‹ ìœ íš¨ì„± ê²€ì‚¬
                    if(choice.match(/^\d{4}-\d{2}-\d{2}$/)) {
                        handleApi('updateHike', { memberId: memberId, oldDate: fullDateStr, newDate: choice });
                    } else {
                        alert("ë‚ ì§œ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. (YYYY-MM-DD)");
                    }
                }
            };
            grid.appendChild(item);
        });
    }

    function renderUI() {
        const targetQ = document.getElementById('qSelect').value;
        const tbody = document.getElementById('memberList');
        tbody.innerHTML = "";

        db.members.forEach(m => {
            const totalHikes = db.hikes.filter(h => String(h.memberId) === String(m.id));
            const total = totalHikes.length;
            const qCount = totalHikes.filter(h => getQuarter(h.date) === targetQ).length;
            const dDay = calculateDDay(m);
            const dDayClass = dDay <= 7 ? 'd-day-urgent' : '';
            const dDayText = dDay >= 0 ? `D-${dDay}` : `D+${Math.abs(dDay)} (ê²½ê³¼)`;

            // ìš”ì²­: ë ˆë²¨ 0ì¼ ë•Œ ê³µë°± ì²˜ë¦¬
            let badgeHtml = "";
            let levelText = "";
            
            if (total > 0) {
                badgeHtml = `<span class="level-badge">${getLevel(total)}</span>`;
                levelText = `<span class="level-text">Lv ${total}</span>`;
            }

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td style="font-weight:bold;">${m.name}</td>
                <td>
                    ${badgeHtml}
                    ${levelText}
                </td>
                <td style="font-weight:bold;">${qCount}íšŒ</td>
                <td class="${dDayClass}">${dDayText}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    // --- ê¸°ì¡´ ë¡œì§ë“¤ ---
    function getLevel(n) {
        if (n >= 1000) return 'ğŸ«Ÿë¯¸ì§€ì˜ë¬¼ì§ˆ';
        if (n >= 500) return 'ğŸ’  ì´ˆì‹ ì„±';
        if (n >= 100) return 'ğŸŒŒ ì€í•˜ìˆ˜';
        if (n >= 90) return 'ğŸŒ  ë³„ë˜¥ë³„';
        if (n >= 80) return 'ğŸ’« íƒ€ì›ë³„';
        if (n >= 70) return 'ğŸŒŸ í™©ê¸ˆë³„';
        if (n >= 60) return 'â­ï¸ ë³„';
        if (n >= 50) return 'â˜€ï¸ í•´';
        if (n >= 45) return 'ğŸŒ• ë‹¬';
        if (n >= 40) return 'ğŸŒ™ ì´ˆìŠ¹ë‹¬';
        if (n >= 35) return 'â˜„ï¸ ìš´ì„';
        if (n >= 30) return 'ğŸŒˆ ë¬´ì§€ê°œ';
        if (n >= 25) return 'ğŸŒ€ íƒœí’';
        if (n >= 20) return 'ğŸŒ‹ í™”ì‚°';
        if (n >= 15) return 'ğŸ” ì„¤ì‚°';
        if (n >= 10) return 'â›°ï¸ ì‚°';
        if (n >= 5)  return 'ğŸŒ³ ë‚˜ë¬´';
        if (n >= 3)  return 'ğŸŒ¿ í’€ì';
        return 'ğŸŒ± ìƒˆì‹¹';
    }

    function getQuarter(dateStr) {
        const d = new Date(dateStr);
        if(isNaN(d.getTime())) {
            let s = String(dateStr).replace(/\./g, '-').replace(/\s/g, '');
            let d2 = new Date(s);
            if(!isNaN(d2.getTime())) return `${d2.getFullYear()}ë…„ ${Math.ceil((d2.getMonth()+1)/3)}ë¶„ê¸°`;
            return "ì˜¤ë¥˜";
        }
        return `${d.getFullYear()}ë…„ ${Math.ceil((d.getMonth()+1)/3)}ë¶„ê¸°`;
    }

    function calculateDDay(member) {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        const memberHikes = db.hikes
            .filter(h => String(h.memberId) === String(member.id))
            .map(h => {
                let d = new Date(h.date);
                if(isNaN(d.getTime())) {
                    let s = String(h.date).replace(/\./g, '-').replace(/\s/g, '');
                    d = new Date(s);
                }
                return isNaN(d.getTime()) ? null : d;
            })
            .filter(d => d !== null)
            .sort((a, b) => b - a);

        let targetDate;
        if (memberHikes.length === 0) {
            let jDate = new Date(member.joinDate);
            if(isNaN(jDate.getTime())) jDate = new Date(); 
            jDate.setHours(0, 0, 0, 0);
            targetDate = new Date(jDate);
            targetDate.setDate(jDate.getDate() + 31);
        } else {
            const lastHike = memberHikes[0];
            lastHike.setHours(0, 0, 0, 0);
            targetDate = new Date(lastHike);
            targetDate.setDate(lastHike.getDate() + 122);
        }
        return Math.ceil((targetDate.getTime() - today.getTime()) / (1000 * 60 * 60 * 24));
    }

    function initQuarterSelect() {
        const select = document.getElementById('qSelect');
        const prevVal = select.value;
        const qs = new Set();
        qs.add(getQuarter(new Date()));
        db.hikes.forEach(h => {
            const q = getQuarter(h.date);
            if(q !== "ì˜¤ë¥˜") qs.add(q);
        });
        select.innerHTML = "";
        Array.from(qs).sort().reverse().forEach(q => {
            select.innerHTML += `<option value="${q}">${q}</option>`;
        });
        if(prevVal && Array.from(qs).includes(prevVal)) select.value = prevVal;
    }

    function updateMemberDropdowns() {
        const mSelect = document.getElementById('mSelect');
        const dSelect = document.getElementById('dSelect');
        const eSelect = document.getElementById('editMemberSelect'); // [NEW] ìˆ˜ì •ìš© ë“œë¡­ë‹¤ìš´
        
        const opts = '<option value="">íšŒì› ì„ íƒ</option>';
        mSelect.innerHTML = opts;
        dSelect.innerHTML = '<option value="">ì‚­ì œí•  íšŒì› ì„ íƒ</option>';
        eSelect.innerHTML = '<option value="">ê¸°ë¡ì„ í™•ì¸í•  íšŒì› ì„ íƒ</option>';

        db.members.forEach(m => {
            const opt = `<option value="${m.id}">${m.name}</option>`;
            mSelect.innerHTML += opt;
            dSelect.innerHTML += opt;
            eSelect.innerHTML += opt;
        });
    }

    function unlockAdmin() {
        if(document.getElementById('adminPw').value === ADMIN_PASSWORD) {
            document.getElementById('lockScreen').style.display = 'none';
            document.getElementById('adminContent').style.display = 'block';
        } else alert("ë¹„ë²ˆ ì˜¤ë¥˜");
    }

    function showTab(id) {
        document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(id === 'dashboard') {
            document.getElementById('tab-dash').classList.add('active');
            renderUI();
        } else { 
            document.getElementById('tab-admin').classList.add('active');
        }
    }
</script>
</body>
</html>